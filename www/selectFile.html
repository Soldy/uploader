<!DOCTYPE html>
<html>
    <head>
        <style>
            body{
                position:absolute;
                background:#d4ebff;
                width:1980px;
                height:1080px;
                margin:0;
                -webkit-box-shadow: inset 22px 10px 347px 18px rgba(0,134,224,1);
                -moz-box-shadow: inset 22px 10px 347px 18px rgba(0,134,224,1);
                box-shadow: inset 22px 10px 347px 18px rgba(0,134,224,1);
                overflow:hidden;
            }
            .statusBarHouse{
                position:relative;
                height:9px;
                width:104px;
                background:#fff;
                border:solid 1px #000;
            }
            .statusBar{
                position:relative;
                height:5px;
                width:0px;
                margin:2px;
                background:#aaa; 
            }            
        </style>
        <script>

        </script>
    </head>
    <body>
        <input type="file" id="files" name="file" /> 
        <button id="fileSendButton">send file</button>
        <div class="statusBarHouse"><div class="statusBar" id="statusBar"  ></div></div>
        <script>


            var fileRead = new FileReader();
            var pieces = {};
/*
            function uploader(fileElement, element) {
                this.element = element;
                this.files = fileElement;
                this.pieces = {};
                this.barMax = 100;
                this.netSend = function (send) {
                    if (window.XMLHttpRequest) {
                        var xmlhttp = new XMLHttpRequest();
                    } else {
                        var xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                    }
                    xmlhttp.onreadystatechange = function () {
                        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                            var incomming = JSON.parse(xmlhttp.responseText.toString());
                            if ((incomming.command == "request") && (incomming.status == "ok")) {
                                this.registerUpload(incomming);
                            } else if ((incomming.command == "upload") && (incomming.status == "ok")) {
                                this.pieces[incomming.fileId].piece++;
                                this.pieceUpload(incomming.fileId);
                            }

                        }
                    };
                    xmlhttp.overrideMimeType('application/json');
                    xmlhttp.open("POST", "/", true);
                    xmlhttp.send(JSON.stringify(send));

                }
                function startUpload = functon(element) {
                    if (!this.files.length) {
                        alert('Please select a file!');
                        return;
                    }
                    var file = this.files[0];
                    this.netSend({command: "request", size: file.size.toString(), type: file.type.toString(), name: file.name.toString()});
                }
                this.pieceUpload = function (id) {
                    this.files;
                    if (!files.length) {
                        alert('Please select a file!');
                        return;
                    }
                    var file = this.files[0];
                    var reader = new FileReader();
                    reader.onloadend = function (evt) {
                        if (evt.target.readyState == FileReader.DONE) { // DONE == 2
                            this.netSend({command: "upload", id: id, piece: pieces[id.toString()].piece, data: btoa(evt.target.result)});
                        }
                    };

                    var blob = file.slice((pieces[id.toString()].piece * this.pieces[id.toString()].size), ((this.pieces[id.toString()].piece + 1) * this.pieces[id.toString()].size));
                    reader.readAsBinaryString(blob);
                }

            }
*/

            function netSend(send) {
                if (window.XMLHttpRequest) {
                    var xmlhttp = new XMLHttpRequest();
                } else {
                    var xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                }
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                        console.log(xmlhttp.responseText.toString());
                        var incomming = JSON.parse(xmlhttp.responseText.toString());
                        if ((incomming.command == "request") && (incomming.status == "ok")) {
                            registerUpload(incomming);
                        } else if ((incomming.command == "upload") && (incomming.status == "ok")) {
                            pieces[incomming.fileId].piece++;
                            pieceUpload(incomming.fileId);
                            barRefreshUpload(incomming.fileId);
                        }

                    }
                };
                xmlhttp.overrideMimeType('application/json');
                xmlhttp.open("POST", "/", true);
                xmlhttp.send(JSON.stringify(send));

            }

            document.getElementById('fileSendButton').addEventListener('click', function () {
                startUpload();
            });

            function barRefreshUpload(id) {
                document.getElementById("statusBar").style.width = ((100/pieces[id.toString()].pieceEnd)*(pieces[id.toString()].piece+1))+"px"
            }
            function registerUpload(incomming) {
                pieces[incomming.fileId.toString()] = {
                    pieceEnd: incomming.pieces,
                    size: incomming.pieceSize,
                    piece: 0
                }
                pieceUpload(incomming.fileId);
            }
            function pieceUpload(id) {
                var files = document.getElementById('files').files;
                if (!files.length) {
                    alert('Please select a file!');
                    return;
                }
                var file = files[0];
                var reader = new FileReader();
                reader.onloadend = function (evt) {
                    if (evt.target.readyState == FileReader.DONE) { // DONE == 2
                        netSend({command: "upload", id: id, piece: pieces[id.toString()].piece, data: btoa(evt.target.result)});
                    }
                };

                var blob = file.slice((pieces[id.toString()].piece * pieces[id.toString()].size), ((pieces[id.toString()].piece + 1) * pieces[id.toString()].size));
                reader.readAsBinaryString(blob);
            }

            function startUpload(el) {
                var files = document.getElementById('files').files;
                if (!files.length) {
                    alert('Please select a file!');
                    return;
                }
                var file = files[0];
                console.log(file);
                netSend({command: "request", size: file.size.toString(), type: file.type.toString(), name: file.name.toString()});
            }
        </script>

    </body>
</html>











